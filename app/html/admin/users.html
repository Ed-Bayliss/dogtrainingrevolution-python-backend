{% extends "/master/logged_in.html" %}
{% block content %}
<div class="container pt-5">
    <div class="row pt-5">
        <div class="col-12">
            {% if existing_user.account_type == "admin" %}
            <button type="button" class="btn btn-sm btn-outline-light float-end" title="Add New" data-bs-toggle="modal" data-bs-target="#mdlogin"><i class="fas fa-add me-2"></i>Add New</button>
            {% endif %}
            <h5><span id="usercount" class="me-2">{{users|length}}</span>Users</h5>
        </div>
        <div class="col-12 pt-2">
            <table class="table table-striped">
                <thead>
                    <tr>
                      <th scope="col" class="table_icon">&nbsp;</th>
                      <th scope="col">Name</th>
                      <th scope="col">Email</th>
                      <th scope="col">Phone</th>
                      <th scope="col" class="table_icon">Level</th>
                      <th scope="col" class="table_count">Pets</th>
                      <th scope="col" class="table_count">Verified</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for user in users %}
                    <tr>
                      <th scope="row" class="table_icon"><i class="fas fa-edit" onclick="showeditmd('{{user.id}}');"></i></th>
                      <td>{{user.firstname}} {{user.surname}}</td>
                      <td><i class="fas fa-envelope me-1"></i>{{user.email}}</td>
                      <td><i class="fas fa-phone me-1"></i>{{user.phone}}</td>
                      <td class="table_icon">
                        {% if user.account_type == "admin" %}
                            <i class="fas fa-certificate"></i>
                        {% else %}
                            <i class="fas fa-user"></i>
                        {% endif %}
                        </td>
                      <td scope="col" class="table_count">
                        {{user.pets}}
                      </td>
                      <td scope="col" class="table_count">
                        {% if user.verified == true %}
                            <i class="fas fa-check"></i>
                        {% else %}
                            <i class="fas fa-x"></i>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="mdedituser" tabindex="-1" aria-labelledby="mdedituser" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5">Edit User</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="hfuserRef">
            <div class="form-outline mb-2">
                <label class="form-label" for="editfirstname">First Name</label>
                <input type="text" id="editfirstname" class="form-control"/>                      
            </div>
            <!-- Name input -->
            <div class="form-outline mb-2">
                <label class="form-label" for="editsurname">Surname</label>
                <input type="text" id="editsurname" class="form-control"/>                      
            </div>

            <!-- Email input -->
            <div class="form-outline mb-2">
                <label class="form-label" for="editemail">Email</label>
                <input type="email" id="editemail" class="form-control"/>
            </div>

            <!-- Phone input -->
            <div class="form-outline mb-2">
                <label class="form-label" for="editphone">Phone Number</label>
                <input type="phone" id="editphone" class="form-control"/>
            </div>   
            <!-- Phone input -->
            <div class="form-outline mb-2">
                <label class="form-label" for="editlevel">User Level</label>
                <select id="editlevel" class="form-select">
                    {% if existing_user.account_type == "admin" %}
                        <option value="admin">Admin</option>
                    {% endif %}                    
                    <option value="client">Client</option>
                </select>
            </div>   
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="cbVerified" {% if existing_user.account_type != "admin" %}disabled{% endif %} >
                <label class="form-check-label text-black" for="cbVerified">
                  Is Verified
                </label>
            </div>
        </div>
        <div class="modal-footer" style="justify-content: space-between;">
            {% if existing_user.account_type == "admin" %}
                <button type="button" class="btn btn-danger" onclick="deleteuser();"><i class="fas fa-trash me-2"></i>Delete user</button>
            {% endif %} 
            <button type="button" class="btn login_button" onclick="updateuser();"><i class="fas fa-save me-2"></i>Save changes</button>
        </div>
      </div>
    </div>
</div>

<div class="modal fade" id="mdlogin" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="mdlogin" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        
        <!-- Modal header -->
        <div class="modal-header">
            <h1 class="modal-title fs-5">Add User</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <!-- Modal body -->
        <div class="modal-body">
            <form>
            <!-- Name input -->
            <div class="form-outline mb-2">
                <label class="form-label" for="registerName">First Name</label>
                <input type="text" id="registerName" class="form-control" required/>                      
            </div>
            <!-- Name input -->
            <div class="form-outline mb-2">
                <label class="form-label" for="registersurName">Surname</label>
                <input type="text" id="registersurName" class="form-control" required/>                      
            </div>

            <!-- Email input -->
            <div class="form-outline mb-2">
                <label class="form-label" for="registerEmail">Email</label>
                <input type="email" id="registerEmail" class="form-control" required/>
            </div>

            <!-- Phone input -->
            <div class="form-outline mb-2">
                <label class="form-label" for="registerPhone">Phone Number</label>
                <input type="phone" id="registerPhone" class="form-control" required/>
            </div>            

            <div id="signupAlertPlaceholder">
            </div>

            <div class="row mt-2">
                <div class="col-9 d-flex justify-content-start">
                    <!-- Checkbox -->
                    <div class="form-check d-flex justify-content-center mb-4">
                        <input class="form-check-input me-2" type="checkbox" value="" id="registerCheck" checked aria-describedby="registerCheckHelpText" />
                        <label class="form-check-label text-black" for="registerCheck">
                        I have read and agree to the terms
                        </label>
                    </div>
                </div>
                <div class="col-3 d-flex justify-content-end">
                    <!-- Submit button -->
                    <button type="button" class="btn btn-primary btn-block mb-3 login_button" onclick="signup();">Sign up</button>
                </div>
            </div>                    
            </form>  
        </div>
      </div>
    </div>
</div>

<script>
    function showeditmd(userRef){
        showLoadingOverlay();
        document.getElementById("hfuserRef").value = userRef;
        var data = {userRef: userRef};
        sendDataUrl('/loaduserdetails', JSON.stringify(data), function (response) {
            document.getElementById("editfirstname").value = response[0]['firstname'];
            document.getElementById("editsurname").value = response[0]['surname'];
            document.getElementById("editemail").value = response[0]['email'];
            document.getElementById("editphone").value = response[0]['phone'];
            document.getElementById("editlevel").value = response[0]['account_type'];
            document.getElementById("cbVerified").checked = response[0]['verified'];
            $('#mdedituser').modal('show');
            hideLoadingOverlay();
        });        
    }

    function signup(){
        // Get the values from the input fields
        showLoadingOverlay();
        document.getElementById('signupAlertPlaceholder').innerHTML = '';
        var registerName = document.getElementById('registerName').value;
        var registersurName = document.getElementById('registersurName').value;
        var registerEmail = document.getElementById('registerEmail').value;
        var registerPhone = document.getElementById('registerPhone').value;
        var registerCheck = document.getElementById('registerCheck').checked;

        // Regular expression for validating an email address
        var emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        // console.log(registerCheck);
        if (emailPattern.test(registerEmail) && registerName !='' && registerPhone !='' & registerCheck == true) {
            var data = {
            registerEmail: registerEmail.toLowerCase(),
            registerName: registerName,
            registersurName: registersurName,
            registerPhone: registerPhone,
            };
            sendDataUrl('/signup', JSON.stringify(data), function (response) {
            if (response['error'] == 500) {
                var alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning alert-dismissible fade show';
                alertDiv.role = 'alert';
                alertDiv.textContent = 'user already added to system';
                var closeButton = document.createElement('button');
                closeButton.type = 'button';
                closeButton.className = 'btn-close';
                closeButton.setAttribute('data-bs-dismiss', 'alert');
                closeButton.setAttribute('aria-label', 'Close');
                alertDiv.appendChild(closeButton);
                document.getElementById('signupAlertPlaceholder').appendChild(alertDiv);
            } else {
                location.reload();
            }
            });
        } else {
            var alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning alert-dismissible fade show';
            alertDiv.role = 'alert';
            alertDiv.textContent = 'please complete all fields first';
            var closeButton = document.createElement('button');
            closeButton.type = 'button';
            closeButton.className = 'btn-close';
            closeButton.setAttribute('data-bs-dismiss', 'alert');
            closeButton.setAttribute('aria-label', 'Close');
            alertDiv.appendChild(closeButton);
            document.getElementById('signupAlertPlaceholder').appendChild(alertDiv);
            hideLoadingOverlay();
        }
    }

    function updateuser(){
        showLoadingOverlay();
        var data = {userRef: document.getElementById("hfuserRef").value, 
        firstname: document.getElementById("editfirstname").value, 
        surname: document.getElementById("editsurname").value, 
        email: document.getElementById("editemail").value, 
        phone: document.getElementById("editphone").value, 
        account_type: document.getElementById("editlevel").value,
        verified: document.getElementById("cbVerified").checked};

        sendDataUrl('/updateduserdetails', JSON.stringify(data), function (response) {
            location.reload();
        });
    }
    function deleteuser(){
        if (confirm("Do you want to delete this user") == true) {
            showLoadingOverlay();
            var data = {userRef: document.getElementById("hfuserRef").value}
            sendDataUrl('/deleteuserdetails', JSON.stringify(data), function (response) {
                location.reload();
            });
        }
    }

</script>
{% endblock %}