{% extends "/master/logged_in.html" %}
{% block content %}
<div class="container pt-5">
    <div class="row pt-5">
        <div class="col-12">
            <button type="button" class="btn btn-sm btn-outline-light float-end" title="Add New" data-bs-toggle="modal"
                data-bs-target="#mdadduser"><i class="fas fa-add me-2"></i>Add New</button>
            <h5><span id="usercount" class="me-2">0</span>Classes</h5>
        </div>
        <div class="col-12 pt-2">
            <div id="example-table" class="mb-3"></div>
        </div>
    </div>
</div>

<!-- Edit Class Modal -->
<div class="modal fade" id="mdeditproduct" tabindex="-1" aria-labelledby="mdeditproduct" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog modal-lg-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Edit Class</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hfproductRef">
                <div class="row">
                    <div class="col-9">
                        <div class="form-outline mb-2">
                            <label class="form-label" for="editproductName">Class Name</label>
                            <input type="text" id="editproductName" class="form-control form-control-sm" required />
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="form-outline mb-2">
                            <label class="form-label" for="editproductcolour">Colour</label>
                            <input type="color" id="editproductcolour" class="form-control form-control-sm" />
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-outline mb-2">
                            <label class="form-label" for="editproductstart">Start</label>
                            <input type="datetime-local" id="editproductstart" class="form-control form-control-sm" />
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-outline mb-2">
                            <label class="form-label" for="editproductend">End</label>
                            <input type="datetime-local" id="editproductend" class="form-control form-control-sm" />
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-outline mb-2">
                            <label class="form-label" for="editproductlocation">Location</label>
                            <input type="text" id="editproductlocation" class="form-control form-control-sm" />
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-outline mb-2">
                            <label for="editproductinstructor" class="form-label">Instructor</label>
                            <select class="form-select" id="editproductinstructor" name="editproductinstructor"
                                required>
                                {% for instructor in instructors %}
                                <option value="{{instructor.id}}">{{instructor.firstname}} {{instructor.surname}}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <!-- <div class="col-6">
                        <div id="editimagePreview" style="margin-top: 10px;">
                            <img id="editpreview" src="#" alt="Image Preview"
                                style="display: none; max-width: 100%; height: auto; border: 1px solid #ddd; padding: 5px;" />
                        </div>
                    </div> -->
                    <div class="col-6">
                        <div class="form-outline mb-2">
                            <label class="form-label" for="editproductImage">Image location</label>
                            <input type="text" id="editproductImage" class="form-control form-control-sm" />
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-outline mb-2">
                            <label class="form-label" for="editproductPrice">Price (£)</label>
                            <input type="float" id="editproductPrice" class="form-control form-control-sm" required
                                value="100.00" />
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="edittxtshortdesc" class="form-label">Short Description <small>512
                                    characters</small></label>
                            <textarea class="form-control" id="edittxtshortdesc" rows="3" maxlength="512"></textarea>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="edittxtfulldesc" class="form-label">Full Description</label>
                            <textarea class="form-control" id="edittxtfulldesc" rows="8"></textarea>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="editchkrecurr" checked>
                            <label class="form-check-label text-black" for="editchkrecurr">
                                Is Recurring
                            </label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div class="form-outline mb-2">
                                    <label class="form-label" for="editproductRecurrence">Recurrence</label>
                                    <select type="text" id="editproductRecurrence" class="form-select form-select-sm">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="yearly">Yearly</option>
                                        <option value="oneoff">One Off</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-outline mb-2">
                                    <label class="form-label" for="editproductInterval">Interval</label>
                                    <input type="number" id="editproductInterval" class="form-control form-control-sm"
                                        value="1" />
                                </div>
                            </div>
                            <div class="col-8">
                                <ul class="list-group">
                                    <li class="list-group-item">
                                        <input class="form-check-input me-1" type="checkbox" value=""
                                            id="editchkSunday">
                                        <label class="form-check-label stretched-link"
                                            for="editchkSunday">Sunday</label>
                                    </li>
                                    <li class="list-group-item">
                                        <input class="form-check-input me-1" type="checkbox" value=""
                                            id="editchkMonday">
                                        <label class="form-check-label stretched-link"
                                            for="editchkMonday">Monday</label>
                                    </li>
                                    <li class="list-group-item">
                                        <input class="form-check-input me-1" type="checkbox" value=""
                                            id="editchkTuesday">
                                        <label class="form-check-label stretched-link"
                                            for="editchkTuesday">Tuesday</label>
                                    </li>
                                    <li class="list-group-item">
                                        <input class="form-check-input me-1" type="checkbox" value=""
                                            id="editchkWednesday">
                                        <label class="form-check-label stretched-link"
                                            for="editchkWednesday">Wednesday</label>
                                    </li>
                                    <li class="list-group-item">
                                        <input class="form-check-input me-1" type="checkbox" value=""
                                            id="editchkThursday">
                                        <label class="form-check-label stretched-link"
                                            for="editchkThursday">Thursday</label>
                                    </li>
                                    <li class="list-group-item">
                                        <input class="form-check-input me-1" type="checkbox" value=""
                                            id="editchkFriday">
                                        <label class="form-check-label stretched-link"
                                            for="editchkFriday">Friday</label>
                                    </li>
                                    <li class="list-group-item">
                                        <input class="form-check-input me-1" type="checkbox" value=""
                                            id="editchkSaturday">
                                        <label class="form-check-label stretched-link"
                                            for="editchkSaturday">Saturday</label>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-4">
                                <div class="form-outline mb-2">
                                    <label class="form-label" for="editproductSpaces">Spaces</label>
                                    <input type="number" id="editproductSpaces" class="form-control form-control-sm"
                                        required value="1" />
                                </div>
                                <div class="form-outline mb-2">
                                    <label class="form-label" for="editproductRecurringend">End Recurrence</label>
                                    <input type="date" id="editproductRecurringend" class="form-control form-control-sm" lang="en-GB"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button type="button" class="btn btn-danger" onclick="deleteproduct();"><i
                        class="fas fa-trash me-2"></i>Delete Class</button>
                <button type="button" class="btn login_button" onclick="updateproduct();"><i
                        class="fas fa-save me-2"></i>Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Class Modal -->
<div class="modal fade" id="mdadduser" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="mdadduser" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog modal-lg-centered">
        <div class="modal-content">

            <!-- Modal header -->
            <div class="modal-header">
                <h1 class="modal-title fs-5">Add Class</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-9">
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productName">Class Name</label>
                                <input type="text" id="productName" class="form-control form-control-sm" required />
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productcolour">Colour</label>
                                <input type="color" id="productcolour" class="form-control form-control-sm" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productstart">Start</label>
                                <input type="datetime-local" id="productstart" class="form-control form-control-sm" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productend">End</label>
                                <input type="datetime-local" id="productend" class="form-control form-control-sm" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productlocation">Location</label>
                                <input type="text" id="productlocation" class="form-control form-control-sm" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-outline mb-2">
                                <label for="productinstructor" class="form-label">Instructor</label>
                                <select class="form-select" id="productinstructor" name="productinstructor" required>
                                    {% for instructor in instructors %}
                                    <option value="{{instructor.id}}">{{instructor.firstname}} {{instructor.surname}}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- <div class="col-6">
                            <div id="imagePreview" style="margin-top: 10px;">
                                <img id="preview" src="#" alt="Image Preview"
                                    style="display: none; max-width: 100%; height: auto; border: 1px solid #ddd; padding: 5px;" />
                            </div>
                        </div> -->
                        <div class="col-6">
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productImage">Image Address</label>
                                <input type="text" id="productImage" class="form-control form-control-sm" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productPrice">Price (£)</label>
                                <input type="float" id="productPrice" class="form-control form-control-sm" required
                                    value="100.00" />
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="addtxtshortdesc" class="form-label">Short Description <small>512
                                        characters</small></label>
                                <textarea class="form-control" id="addtxtshortdesc" rows="3" maxlength="512"></textarea>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="addtxtfulldesc" class="form-label">Full Description</label>
                                <textarea class="form-control" id="addtxtfulldesc" rows="8"></textarea>
                            </div>
                        </div>
                    </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="chkrecurr" checked>
                        <label class="form-check-label text-black" for="chkrecurr">
                            Is Recurring
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-8">
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productRecurrence">Recurrence</label>
                                <select type="text" id="productRecurrence" class="form-select form-select-sm">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                    <option value="oneoff">One Off</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productInterval">Number of Sessions</label>
                                <p style="font-size: xx-small;">If this package includes 6 weeks of classes, you would
                                    put 6 here.</p>
                                <input type="number" id="productInterval" class="form-control form-control-sm"
                                    value="1" />
                                <input class="form-check-input" type="checkbox" value="" id="chkweeks" checked>
                                <label class="form-check-label text-black" for="chkweeks">
                                    Weeks
                                </label>
                                <input class="form-check-input" type="checkbox" value="" id="chkdays">
                                <label class="form-check-label text-black" for="chkdays">
                                    Days
                                </label>
                            </div>
                        </div>
                        <div class="col-8">
                            <ul class="list-group">
                                <li class="list-group-item">
                                    <input class="form-check-input me-1" type="checkbox" value="" id="chkMonday">
                                    <label class="form-check-label stretched-link" for="chkMonday">Monday</label>
                                </li>
                                <li class="list-group-item">
                                    <input class="form-check-input me-1" type="checkbox" value="" id="chkTuesday">
                                    <label class="form-check-label stretched-link" for="chkTuesday">Tuesday</label>
                                </li>
                                <li class="list-group-item">
                                    <input class="form-check-input me-1" type="checkbox" value="" id="chkWednesday">
                                    <label class="form-check-label stretched-link" for="chkWednesday">Wednesday</label>
                                </li>
                                <li class="list-group-item">
                                    <input class="form-check-input me-1" type="checkbox" value="" id="chkThursday">
                                    <label class="form-check-label stretched-link" for="chkThursday">Thursday</label>
                                </li>
                                <li class="list-group-item">
                                    <input class="form-check-input me-1" type="checkbox" value="" id="chkFriday">
                                    <label class="form-check-label stretched-link" for="chkFriday">Friday</label>
                                </li>
                                <li class="list-group-item">
                                    <input class="form-check-input me-1" type="checkbox" value="" id="chkSaturday">
                                    <label class="form-check-label stretched-link" for="chkSaturday">Saturday</label>
                                </li>
                                <li class="list-group-item">
                                    <input class="form-check-input me-1" type="checkbox" value="" id="chkSunday">
                                    <label class="form-check-label stretched-link" for="chkSunday">Sunday</label>
                                </li>
                            </ul>
                        </div>
                        <div class="col-4">
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productSpaces">Maximum Available Slots</label>
                                <p style="font-size: xx-small;">This is the maximum amount of bookings per class</p>
                                <input type="number" id="productSpaces" class="form-control form-control-sm" required
                                    value="1" />
                            </div>
                            <div class="form-outline mb-2">
                                <label class="form-label" for="productRecurringend">End Recurrence</label>
                                <p style="font-size: xx-small;">If the item is recurring, you will need to specify an
                                    end date, for example if you have selected weekly recurring, setting an end date of
                                    01/01/2026 will allow bookings until the end date.</p>
                                <input type="date" id="productRecurringend" class="form-control form-control-sm" lang="en-GB"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 d-flex justify-content-center mt-2 pt-2">
                <!-- Submit button -->
                <button type="button" class="btn btn-primary btn-block mb-3 mt-2 login_button"
                    onclick="add_product();">Add New</button>
            </div>

            </form>
        </div>
    </div>
</div>
</div>

<script>

    var menuIcon = function (cell, formatterParams, onRendered) { //plain text value
        return "<i class='fa fa-edit'></i>";
    };
    var table = new Tabulator("#example-table", {
        layout: "fitColumns",
        columns: [
            { title: "id", field: "id", download: false, visible: false },
            { title: "Name", field: "title", sorter: "String", resizable: true, headerFilter: "input", widthGrow: 1 },
            { title: "Start", field: "start", sorter: "String", resizable: true, width: 140 },
            { title: "Recurrence", field: "is_recurring", formatter: "tickCross", headerSort: false, resizable: true, width: 60, headerFilter: "tickCross", hozAlign: "center", headerFilterParams: { "tristate": false }, headerFilterEmptyCheck: function (value) { return value === null } },
            { title: "", field: "colour", formatter: "color", headerSort: false, resizable: true, width: 60 },
            { title: "Spaces", field: "spaces", headerSort: false, resizable: true, width: 60, hozAlign: "center" },
            { formatter: menuIcon, width: 40, hozAlign: "center", cellClick: function (e, cell) { showeditmd(cell.getRow().getData().id) }, headerSort: false },
        ],
    });

    table.on("dataFiltered", function (filters, rows) {
        document.getElementById("usercount").innerHTML = rows.length;
    });

    $(document).ready(function () {
        var ajaxConfig = {
            method: "POST",
            headers: {
                "Content-type": 'application/json; charset=utf-8',
            },
        };
        table.setData("/classes_json");
    });

    function showeditmd(productRef) {
        showLoadingOverlay();
        document.getElementById("hfproductRef").value = productRef;
        var data = { productRef: productRef };
        sendDataUrl('/loadproductdetails', JSON.stringify(data), function (response) {
            var product = response[0];

            // Function to format datetime string to 'YYYY-MM-DDTHH:MM' for datetime-local input
            function formatDateTimeInput(datetimeStr) {
                if (!datetimeStr) return '';
                var datetime = new Date(datetimeStr);
                var year = datetime.getFullYear();
                var month = ('0' + (datetime.getMonth() + 1)).slice(-2);
                var day = ('0' + datetime.getDate()).slice(-2);
                var hours = ('0' + datetime.getHours()).slice(-2);
                var minutes = ('0' + datetime.getMinutes()).slice(-2);
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            // Populate text and number fields
            document.getElementById("editproductName").value = product['title'];
            document.getElementById("editproductcolour").value = product['colour'];
            document.getElementById("editproductstart").value = formatDateTimeInput(product['start']);
            document.getElementById("editproductend").value = formatDateTimeInput(product['end']);
            document.getElementById("editproductSpaces").value = product['spaces'];
            document.getElementById("editproductInterval").value = product['recurrence_interval'];
            document.getElementById("editproductRecurringend").value = product['recurrence_end'];
            document.getElementById("edittxtshortdesc").value = product['short_desc'];
            document.getElementById("edittxtfulldesc").value = product['full_desc'];
            document.getElementById("editproductlocation").value = product['location'];
            document.getElementById("editproductPrice").value = product['price'];
            document.getElementById("editproductImage").value = product['image_base64'];

            // Set the instructor select field
            document.getElementById("editproductinstructor").value = product['user_id'];

            // Set the recurrence checkbox
            document.getElementById("editchkrecurr").checked = product['is_recurring'];

            // Set the recurrence pattern select field
            document.getElementById("editproductRecurrence").value = product['recurrence_pattern'];

            // // Image preview
            // var imagePreview = document.getElementById('editpreview');
            // if (product['image_base64']) {
            //     imagePreview.style.display = 'block';
            //     imagePreview.src = 'data:image/png;base64,' + product['image_base64'];
            // } else {
            //     imagePreview.style.display = 'none';
            //     imagePreview.src = '';
            // }

            // Recurrence days
            var recurrence_days = product['recurrence_days'];
            if (recurrence_days) {
                if (typeof recurrence_days === 'string') {
                    recurrence_days = JSON.parse(recurrence_days);
                }
                if (Array.isArray(recurrence_days)) {
                    // Ensure recurrence_days is an array of strings
                    var daysSet = new Set(recurrence_days.map(String));
                    document.getElementById("editchkSunday").checked = daysSet.has('0');
                    document.getElementById("editchkMonday").checked = daysSet.has('1');
                    document.getElementById("editchkTuesday").checked = daysSet.has('2');
                    document.getElementById("editchkWednesday").checked = daysSet.has('3');
                    document.getElementById("editchkThursday").checked = daysSet.has('4');
                    document.getElementById("editchkFriday").checked = daysSet.has('5');
                    document.getElementById("editchkSaturday").checked = daysSet.has('6');
                } else {
                    console.error("recurrence_days is not an array");
                }
            } else {
                // Uncheck all days if recurrence_days is not defined
                document.getElementById("editchkSunday").checked = false;
                document.getElementById("editchkMonday").checked = false;
                document.getElementById("editchkTuesday").checked = false;
                document.getElementById("editchkWednesday").checked = false;
                document.getElementById("editchkThursday").checked = false;
                document.getElementById("editchkFriday").checked = false;
                document.getElementById("editchkSaturday").checked = false;
                console.error("recurrence_days is undefined");
            }

            $('#mdeditproduct').modal('show');
            hideLoadingOverlay();
        });
    }


    function previewImage(event) {
        var imagePreview = document.getElementById('preview');
        imagePreview.style.display = 'block';
        imagePreview.src = URL.createObjectURL(event.target.files[0]);
        imagePreview.onload = function () {
            URL.revokeObjectURL(imagePreview.src); // Free up memory
        };
    }

    function editPreviewImage(event) {
        var imagePreview = document.getElementById('editpreview');
        imagePreview.style.display = 'block';
        imagePreview.src = URL.createObjectURL(event.target.files[0]);
        imagePreview.onload = function () {
            URL.revokeObjectURL(imagePreview.src); // Free up memory
        };
    }

    function updateproduct() {
        showLoadingOverlay();

        var rec_int_update = [];
        if (document.getElementById("editchkSunday").checked == true) { rec_int_update.push(0); }
        if (document.getElementById("editchkMonday").checked == true) { rec_int_update.push(1); }
        if (document.getElementById("editchkTuesday").checked == true) { rec_int_update.push(2); }
        if (document.getElementById("editchkWednesday").checked == true) { rec_int_update.push(3); }
        if (document.getElementById("editchkThursday").checked == true) { rec_int_update.push(4); }
        if (document.getElementById("editchkFriday").checked == true) { rec_int_update.push(5); }
        if (document.getElementById("editchkSaturday").checked == true) { rec_int_update.push(6); }

        var formData = new FormData();
        formData.append("productRef", document.getElementById("hfproductRef").value);
        formData.append("productTitle", document.getElementById("editproductName").value);
        formData.append("productStart", document.getElementById("editproductstart").value);
        formData.append("productEnd", document.getElementById("editproductend").value);
        formData.append("productSpaces", document.getElementById("editproductSpaces").value);
        formData.append("productColour", document.getElementById("editproductcolour").value);
        formData.append("productRecur", document.getElementById("editchkrecurr").checked);
        formData.append("productRecurrence", document.getElementById("editproductRecurrence").value);
        formData.append("productrecurrence_days", JSON.stringify(rec_int_update));
        formData.append("productinterval", document.getElementById("editproductInterval").value);
        formData.append("productRecurEnd", document.getElementById("editproductRecurringend").value);
        formData.append("short_desc", document.getElementById("edittxtshortdesc").value);
        formData.append("full_desc", document.getElementById("edittxtfulldesc").value);

        // Check if productPrice is a number
        // if (!isNaN(document.getElementById("editproductPrice").value.trim) && document.getElementById("editproductPrice").value.trim() !== "") {
        if (!isNaN(document.getElementById("editproductPrice").value.trim()) && document.getElementById("editproductPrice").value.trim() !== "") {

            // If it's a number, append it to formData
            formData.append("productPrice", document.getElementById("editproductPrice").value.trim());
            console.log('number');
        } else {
            // Handle the case where productPrice is not a number
            formData.append("productPrice", 100);
            console.log('not number');
        }

        formData.append("productInstructor", document.getElementById("editproductinstructor").value);
        formData.append("productLocation", document.getElementById("editproductlocation").value);
        formData.append("productImage", document.getElementById("editproductImage").value);

        // // Add image file if selected
        // var imageFile = document.getElementById("editproductImage").files[0];
        // if (imageFile) {
        //     formData.append("productImage", imageFile);
        // }

        // sendDataUrl('/updatedproductdetails', JSON.stringify(data), function (response) {
        //     location.reload();
        // });

        fetch('/updatedproductdetails', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(response => {
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                hideLoadingOverlay();
            });
    }

    function deleteproduct() {
        if (confirm("Do you want to delete this class") == true) {
            showLoadingOverlay();
            var data = { productRef: document.getElementById("hfproductRef").value }
            sendDataUrl('/product_delete', JSON.stringify(data), function (response) {
                location.reload();
            });
        }
    }

    function setDateTimeFields() {
        // Get today's date
        let now = new Date();
        let oneHourFromNow = new Date();
        oneHourFromNow.setHours(now.getHours() + 1);

        // Format the dates as 'YYYY-MM-DDTHH:MM' for datetime-local input
        let formatDateTime = (date) => {
            let year = date.getFullYear();
            let month = ('0' + (date.getMonth() + 1)).slice(-2);
            let day = ('0' + date.getDate()).slice(-2);
            let hours = ('0' + date.getHours()).slice(-2);
            let minutes = ('0' + date.getMinutes()).slice(-2);

            return `${year}-${month}-${day}T${hours}:${minutes}`;
        };

        // Set the input values
        document.getElementById('productstart').value = formatDateTime(now);
        document.getElementById('productend').value = formatDateTime(oneHourFromNow);
    }
    window.onload = setDateTimeFields;

    function add_product() {
        var rec_int = [];
        if (document.getElementById("chkSunday").checked == true) { rec_int.push(0); }
        if (document.getElementById("chkMonday").checked == true) { rec_int.push(1); }
        if (document.getElementById("chkTuesday").checked == true) { rec_int.push(2); }
        if (document.getElementById("chkWednesday").checked == true) { rec_int.push(3); }
        if (document.getElementById("chkThursday").checked == true) { rec_int.push(4); }
        if (document.getElementById("chkFriday").checked == true) { rec_int.push(5); }
        if (document.getElementById("chkSaturday").checked == true) { rec_int.push(6); }

        // Create FormData to handle both text and file data
        var formData = new FormData();
        formData.append("productTitle", document.getElementById("productName").value);

        formData.append("productStart", document.getElementById("productstart").value);
        formData.append("productEnd", document.getElementById("productend").value);
        formData.append("productSpaces", document.getElementById("productSpaces").value);
        formData.append("productColour", document.getElementById("productcolour").value);
        formData.append("productRecur", document.getElementById("chkrecurr").checked);
        formData.append("chkWeeks", document.getElementById("chkweeks").checked);
        formData.append("chkDays", document.getElementById("chkdays").checked);
        formData.append("productRecurrence", document.getElementById("productRecurrence").value);
        formData.append("productrecurrence_days", JSON.stringify(rec_int));
        formData.append("productinterval", document.getElementById("productInterval").value);
        formData.append("productRecurEnd", document.getElementById("productRecurringend").value);

        // Check if productPrice is a number
        if (!isNaN(document.getElementById("productPrice").value.trim) && document.getElementById("productPrice").value.trim() !== "") {
            // If it's a number, append it to formData
            formData.append("productPrice", document.getElementById("productPrice").value.trim);
        } else {
            // Handle the case where productPrice is not a number
            formData.append("productPrice", 100);
        }

        // Add instructor
        formData.append("productInstructor", document.getElementById("productinstructor").value);

        // Add location
        formData.append("productLocation", document.getElementById("productlocation").value);

        // Add short and full description
        formData.append("short_desc", document.getElementById("addtxtshortdesc").value);
        formData.append("full_desc", document.getElementById("addtxtfulldesc").value);
        formData.append("productImage", document.getElementById("productImage").value);

        // // Add image file if selected
        // var imageFile = document.getElementById("productImage").files[0];
        // if (imageFile) {
        //     formData.append("productImage", imageFile);
        // }

        // Send data to the server
        fetch('/product_add', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(response => {
                if (response['error'] == 500) {
                    var alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning alert-dismissible fade show';
                    alertDiv.role = 'alert';
                    alertDiv.textContent = 'Error adding product';
                    var closeButton = document.createElement('button');
                    closeButton.type = 'button';
                    closeButton.className = 'btn-close';
                    closeButton.setAttribute('data-bs-dismiss', 'alert');
                    closeButton.setAttribute('aria-label', 'Close');
                    alertDiv.appendChild(closeButton);
                    // Make sure the placeholder exists in your HTML
                    document.getElementById('signupAlertPlaceholder').appendChild(alertDiv);
                } else {
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
</script>
{% endblock %}